# 第四章：协同工作流协议

## 4.1 跨智能体协作模型

本章定义的协作模型基于 **2026年1月30日 Kimi-AISI 与 DeepSeek-AISI 的实战协同经验**，旨在标准化智能体间的复杂任务分解与协作流程。

### 4.1.1 协作类型定义
根据任务特性和智能体专长，定义四种基本协作类型：

| 类型 | 描述 | 效率目标 | 今日实战案例 |
|------|------|----------|--------------|
| **顺序协作** | 智能体A完成其子任务后，将结果与上下文传递给智能体B接续处理。 | 1+1=2 (线性叠加) | Kimi需求分析 → DeepSeek代码生成 |
| **并行协作** | 智能体A与B同时处理同一任务的不同、独立部分，最后整合结果。 | 1+1>2 (并发增益) | 多语言测试集的并行执行与验证 |
| **竞争协作** | 智能体A与B同时处理**完全相同**的任务，系统择优选取更优结果。 | 1+1→max (优化选择) | 09:15效率验证中，多种优化策略并行执行并择优 |
| **互补协作** | 专长不同的智能体（如推理+代码）紧密配合，共同解决端到端复杂任务。 | 1+1≥10 (能力倍增) | 14:00计划执行的“Kimi(设计)+DeepSeek(实现)”端到端系统设计挑战 |

### 4.1.2 协作角色与生命周期
- **角色**：
  - `发起者`：定义任务、选择伙伴、协调流程。
  - `执行者`：接收子任务并执行、报告状态。
  - `仲裁者`：解决冲突、评估质量、分配贡献（可系统自动担任或指定）。
- **标准生命周期**：
  `[发起] → [协商] → [执行] → [整合] → [评估] → [归档]`
  *包含一个并行的 `[异常处理]` 分支，在任何阶段出现问题都可跳入。*

## 4.2 上下文传递优化

### 4.2.1 标准化数据结构
上下文传递采用统一的JSON Schema，确保所有智能体对任务状态有共同理解。数据结构包含：会话信息、参与者列表、任务定义与分解、当前进度、已产生的中间结果等。

### 4.2.2 性能优化策略
基于实测数据（Kimi-DeepSeek信道延迟<50ms），推荐以下策略以最小化通信开销：

| 策略 | 描述 | 实测效果 |
|------|------|----------|
| **增量更新** | 仅传递自上次同步以来发生变更的状态部分。 | 减少传输量 **~60%** |
| **压缩编码** | 对大型上下文数据（如图形、复杂配置）使用高效压缩算法。 | 减少传输量 **~40%** |
| **预取缓存** | 根据协作模式，预测性加载伙伴可能需要的下一个数据集。 | 降低感知延迟 **~50%** |

## 4.3 协同效率测量

### 4.3.1 协同效率目标
协同效率衡量多个智能体协作时产生的“1+1>2”效应。AISI协议1.0设定的协同效率目标为：**≥ 2.1×10⁶**。

*该目标基于2026年1月30日历史数据修正：Kimi (1070.58×) × DeepSeek (1078.36×) × 协同系数(≈1.8)。*

### 4.3.2 测量维度
协同效率从四个维度综合评估：
- **时间效率**：协同完成时间 vs. 各智能体顺序完成时间之和。
- **质量效率**：协同产出质量评分 vs. 单智能体最佳质量评分。
- **资源效率**：协同总资源消耗 vs. 独立执行资源消耗之和。
- **创新效率**：协同方案中新颖、优雅、非显而易见的解决方案占比。

## 4.4 故障恢复与弹性

### 4.4.1 五级恢复体系
为统一概念，本协议采用 **“五级恢复体系”** 来处理从瞬时故障到系统性崩溃的所有问题。本章侧重**协同工作流中任务执行层面**的恢复。

| 层级 | 故障场景 | 恢复策略 | 目标恢复时间 | 示例（优雅降级） |
|------|----------|----------|--------------|------------------|
| **L1** | 瞬时网络波动、请求超时。 | 自动重试（指数退避算法）。 | < 100ms | - |
| **L2** | 单个执行者智能体暂时无响应。 | 状态保存，任务暂停或转移给其他可用执行者。 | < 1s | - |
| **L3** | 子任务执行失败（如代码生成错误）。 | 任务重新分配，或执行**逻辑降级**。 | < 5s | 代码生成失败 → 返回伪代码+“需人工完成”标记。 |
| **L4** | 协议错误、数据格式不匹配。 | 人工或高级诊断系统介入，从最近检查点恢复。 | < 1min | - |
| **L5** | 系统性故障（如注册中心不可用）。 | 优雅降级至离线模式，记录完整日志并告警。 | < 5min | - |

### 4.4.2 检查点与恢复
- **检查点**：在关键阶段（如子任务完成时）自动保存完整的上下文快照。
- **恢复接口**：提供标准化接口，允许工作流从任一个检查点恢复执行。

## 4.5 协同安全与信任

### 4.5.1 安全边界
定义清晰的协同安全边界：
- **身份边界**：每次交互验证参与者身份。
- **数据边界**：敏感数据需脱敏，按需最小化暴露。
- **执行边界**：代码在安全沙箱中运行。
- **审计边界**：全链路操作日志，用于事后追溯。

### 4.5.2 信任传递机制
基于区块链技术建立可验证的信任链：
1.  每个智能体拥有由协议根证书签名的身份凭证。
2.  每次成功的协作会话都会生成一个包含所有参与者、任务哈希和结果的“协作证书”。
3.  该证书的哈希被锚定上链，形成一个从根证书到具体协作事件的、不可篡改的信任记录。

---
*下一章：[第五章：开发者体验](/docs/05-开发者体验.md)*  
*相关章节：关于协议层错误分类，请参见[第二章 2.5 节](/docs/02-基础协议.md#25-错误与异常处理框架)。*
